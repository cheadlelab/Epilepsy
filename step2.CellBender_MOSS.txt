# Activate cellbender environment
conda activate cellbender

# Base directory containing EXP directories
BASE_DIR="/run/user/1000/gvfs/smb-share:server=grid-hs,share=cheadle_home,user=qianyu/qianyu/Epilepsy/Cellranger_output"

# Define an array of SRR directory names
SRR_DIRS=(Exp01 Exp02_Control Exp02_ES Exp02_EU Exp03_EP Exp03_HU Exp04_3E Exp04_4S Exp04_4C Exp04_4E Exp05_5S Exp05_5C Exp05_5E Exp06_6S Exp06_6C Exp06_6E Exp07_4C Exp07_4E Exp07_5E)
SRR_DIRS=(Exp07_5E)


# Flag to control the while loop
flag=TRUE

while [[ "$flag" == "TRUE" ]]; do
  flag=FALSE
  # Loop through the array of SRR directories
  for SRR_DIR in "${SRR_DIRS[@]}"; do
    echo "Processing directory: ${BASE_DIR}/${SRR_DIR}"
    
    # Change directory to the specified SRR directory
    cd "${BASE_DIR}/${SRR_DIR}/outs"
    
    # Check if output_report.html exists
    if [[ ! -e output_report.html ]]; then
      flag=TRUE
      
      # Attempt to run cellbender remove-background
      if cellbender remove-background --cuda --input raw_feature_bc_matrix.h5 --output "output.h5"; then
        echo "Finished processing ${BASE_DIR}/${SRR_DIR}"
      else
        echo "cellbender remove-background failed for ${BASE_DIR}/${SRR_DIR}, will retry."
      fi
      
      sleep 10
      
    else
      echo "${BASE_DIR}/${SRR_DIR} already processed."
    fi
  done
done

echo "All directories processed."
